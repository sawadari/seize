# 要求仕様書 v1.0 - ECサイト ユーザー認証機能

**プロジェクト**: ECサイト ユーザー認証機能の改善
**バージョン**: 1.0
**作成日**: 2025年1月22日
**作成者**: 山田 次郎（開発リード）
**承認者**: 田中 太郎（Product Owner）、佐藤 花子（CISO）

---

## 📋 目次

1. [ビジネス要求](#ビジネス要求)
2. [ユーザー要求](#ユーザー要求)
3. [機能要求](#機能要求)
4. [非機能要求](#非機能要求)
5. [制約](#制約)
6. [受入基準](#受入基準)

---

## ビジネス要求

### BR-001: カート放棄率の削減

**記述**: ユーザー認証プロセスを改善し、カート放棄率を現状の60%から45%以下に削減する必要がある。

**優先度**: Must have
**ステークホルダー**: Product Owner, 経営陣
**関連ユーザー要求**: UR-001, UR-002
**KPI**: カート放棄率 60% → 45%

---

### BR-002: サポートコストの削減

**記述**: パスワード関連のサポート問い合わせを50%削減し、サポートコストを月15万円削減する必要がある。

**優先度**: Must have
**ステークホルダー**: Product Owner, カスタマーサポート
**関連ユーザー要求**: UR-003
**KPI**: パスワード関連問い合わせ 50件/日 → 25件/日

---

### BR-003: セキュリティ強化とコンプライアンス準拠

**記述**: 顧客データを保護し、GDPR/個人情報保護法に準拠したセキュアな認証システムを実装する必要がある。

**優先度**: Must have
**ステークホルダー**: CISO, 法務部
**関連システム要求**: SR-004, SR-005
**法的要件**: GDPR Article 32, 個人情報保護法

---

## ユーザー要求

### UR-001: 簡単なログイン

**記述**: ユーザーは、パスワードを入力せずに簡単にログインできる必要がある。

**優先度**: Must have
**ステークホルダー**: エンドユーザー (54%が要望)
**関連機能要求**: FR-002, FR-003

**受入基準**:
- Given: ユーザーがログイン画面にアクセスした時
- When: ソーシャルログインボタンをクリックする
- Then: 30秒以内にログインが完了する

---

### UR-002: ログイン状態の維持

**記述**: ユーザーは、一定期間ログイン状態を維持し、毎回ログインする必要がないようにしたい。

**優先度**: Should have
**ステークホルダー**: エンドユーザー (39%が要望)
**関連機能要求**: FR-007

---

### UR-003: 自分でパスワードリセット

**記述**: ユーザーは、パスワードを忘れた場合、サポートに連絡せずに自分でリセットできる必要がある。

**優先度**: Must have
**ステークホルダー**: エンドユーザー (47%が要望)
**関連機能要求**: FR-004, FR-005

---

## 機能要求

### FR-001: メールアドレス・パスワードによるログイン

**記述**: システムは、ユーザーがメールアドレスとパスワードでログインできるようにする必要がある。

**優先度**: Must have
**カテゴリ**: 認証
**ステークホルダー**: すべてのユーザー
**関連要求**: NFR-001 (パスワードハッシュ化)

#### 受入基準

**AC-001**: 正常ログイン
- Given: 登録済みユーザーがログインフォームにアクセスした時
- When: 正しいメールアドレスとパスワードを入力してログインボタンをクリックする
- Then: 1秒以内にホーム画面に遷移し、ユーザー名が表示される

**AC-002**: 誤ったパスワード
- Given: ログインフォームにアクセスした時
- When: 正しいメールアドレスと誤ったパスワードを入力する
- Then: "メールアドレスまたはパスワードが正しくありません"とエラーメッセージが表示される

**AC-003**: 未登録メールアドレス
- Given: ログインフォームにアクセスした時
- When: 未登録のメールアドレスを入力する
- Then: "メールアドレスまたはパスワードが正しくありません"とエラーメッセージが表示される（列挙攻撃対策）

**検証方法**: 自動テスト（E2Eテスト）

---

### FR-002: Googleアカウントによるログイン

**記述**: システムは、ユーザーがGoogleアカウントでログインできるようにする必要がある。

**優先度**: Must have
**カテゴリ**: 認証（OAuth 2.0）
**ステークホルダー**: エンドユーザー (82%が希望)
**技術**: OAuth 2.0 + OpenID Connect
**関連要求**: SR-001, NFR-006

#### 受入基準

**AC-001**: Googleログイン成功
- Given: 新規ユーザーがログイン画面にアクセスした時
- When: 「Googleでログイン」ボタンをクリックし、Google認証を完了する
- Then: 30秒以内にアカウントが自動作成され、ホーム画面に遷移する

**AC-002**: 既存アカウントとの連携
- Given: メールアドレス`user@example.com`で既にアカウントが存在する場合
- When: 同じメールアドレスのGoogleアカウントでログインする
- Then: 既存アカウントと自動的に連携され、ログインが完了する

**AC-003**: OAuth 2.0 セキュリティ
- Given: Googleログインフローが開始された時
- When: stateパラメータが検証される
- Then: CSRF攻撃が防止される

**検証方法**: 手動テスト + セキュリティテスト

---

### FR-003: Apple IDによるログイン

**記述**: システムは、ユーザーがApple IDでログインできるようにする必要がある。

**優先度**: Should have
**カテゴリ**: 認証（OAuth 2.0）
**ステークホルダー**: iOSユーザー (51%が希望)
**技術**: Sign in with Apple
**備考**: iOSアプリを提供する場合、Apple Review Guidelinesで必須

#### 受入基準

**AC-001**: Apple IDログイン成功
- Given: iOSデバイスのユーザーがログイン画面にアクセスした時
- When: 「Apple IDでログイン」ボタンをタップし、Face ID/Touch IDで認証する
- Then: 10秒以内にログインが完了する

**AC-002**: メールアドレスのプライバシー保護
- Given: ユーザーが「メールアドレスを隠す」オプションを選択した時
- When: Apple IDログインを完了する
- Then: Apple提供のリレーメールアドレスが登録される

**検証方法**: 実機テスト（iOS）

---

### FR-004: パスワードリセットリクエスト

**記述**: システムは、ユーザーがパスワードをリセットするためのリクエストを送信できるようにする必要がある。

**優先度**: Must have
**カテゴリ**: アカウント管理
**ステークホルダー**: エンドユーザー, カスタマーサポート
**関連要求**: FR-005

#### 受入基準

**AC-001**: パスワードリセットメール送信
- Given: ユーザーが「パスワードを忘れた」リンクをクリックした時
- When: 登録済みのメールアドレスを入力して送信ボタンをクリックする
- Then: 1分以内にパスワードリセット用のメールが送信される

**AC-002**: 未登録メールアドレスの処理
- Given: ユーザーがパスワードリセットフォームにアクセスした時
- When: 未登録のメールアドレスを入力する
- Then: "メールを送信しました"とメッセージが表示される（列挙攻撃対策）

**AC-003**: リセットトークンの有効期限
- Given: パスワードリセットメールが送信された時
- When: 1時間が経過する
- Then: リセットトークンが無効化される

**検証方法**: 自動テスト + 手動テスト

---

### FR-005: パスワードリセットの実行

**記述**: システムは、ユーザーがリセットトークンを使用して新しいパスワードを設定できるようにする必要がある。

**優先度**: Must have
**カテゴリ**: アカウント管理
**関連要求**: FR-004, NFR-001

#### 受入基準

**AC-001**: 新しいパスワードの設定
- Given: ユーザーが有効なリセットトークンでアクセスした時
- When: 新しいパスワードを入力し確定する
- Then: パスワードが更新され、自動的にログインする

**AC-002**: パスワードポリシーの検証
- Given: パスワードリセット画面で新しいパスワードを入力する時
- When: 7文字以下のパスワードを入力する
- Then: "パスワードは最低8文字必要です"とエラーメッセージが表示される

**AC-003**: 既存セッションの無効化
- Given: パスワードリセットが完了した時
- When: 新しいパスワードが設定される
- Then: すべての既存セッションが無効化される（セキュリティ対策）

**検証方法**: 自動テスト

---

### FR-006: 二要素認証の有効化

**記述**: システムは、ユーザーがTOTPベースの二要素認証を有効化できるようにする必要がある。

**優先度**: Should have
**カテゴリ**: セキュリティ
**ステークホルダー**: セキュリティ意識の高いユーザー (32%が希望)
**技術**: TOTP (RFC 6238)
**関連要求**: NFR-002

#### 受入基準

**AC-001**: 2FA設定
- Given: ログイン済みユーザーがアカウント設定画面にアクセスした時
- When: 「二要素認証を有効にする」ボタンをクリックする
- Then: QRコードとバックアップコード(10個)が表示される

**AC-002**: 2FAログイン
- Given: 2FAが有効なユーザーがログインする時
- When: メールアドレス・パスワードを入力後、6桁のワンタイムパスワードを入力する
- Then: 正しいコードで認証が完了し、ホーム画面に遷移する

**AC-003**: バックアップコードの使用
- Given: ユーザーが認証アプリにアクセスできない時
- When: バックアップコードを入力する
- Then: ログインが完了し、使用したコードが無効化される

**検証方法**: 手動テスト + セキュリティテスト

---

### FR-007: ログイン状態の保持

**記述**: システムは、ユーザーが「ログイン状態を保持」オプションを選択した場合、30日間ログイン状態を維持する必要がある。

**優先度**: Should have
**カテゴリ**: ユーザー体験
**関連要求**: NFR-003

#### 受入基準

**AC-001**: ログイン状態保持の有効化
- Given: ユーザーがログインフォームにアクセスした時
- When: 「ログイン状態を保持」チェックボックスをオンにしてログインする
- Then: Secure、HttpOnly、SameSite=Strict属性のクッキーが30日間の有効期限で設定される

**AC-002**: 30日後の自動ログアウト
- Given: 「ログイン状態を保持」でログインしてから30日経過した時
- When: サイトにアクセスする
- Then: 自動的にログアウトされ、ログイン画面にリダイレクトされる

**検証方法**: 自動テスト

---

## 非機能要求

### NFR-001: パスワードの安全な保存 (Security)

**記述**: システムは、ユーザーのパスワードをbcryptでハッシュ化して保存する必要がある。

**カテゴリ**: セキュリティ
**優先度**: Must have
**基準**: OWASP Password Storage Cheat Sheet
**測定方法**: コードレビュー + ペネトレーションテスト

#### 詳細要件

- ハッシュアルゴリズム: bcrypt
- ワークファクター: 12
- ソルト: 各パスワードに対してユニークなソルト（bcryptが自動生成）
- 平文パスワードの非保存: データベース、ログ、メモリダンプに平文パスワードを保存しない

**受入基準**:
- Given: 新規ユーザーがアカウントを作成する時
- When: パスワード"MyP@ssw0rd!"を設定する
- Then: データベースにはbcryptハッシュ（例: "$2b$12$..."）のみが保存され、平文は保存されない

---

### NFR-002: セッショントークンの安全性 (Security)

**記述**: システムは、暗号学的に安全な乱数生成器を使用してセッショントークンを生成する必要がある。

**カテゴリ**: セキュリティ
**優先度**: Must have
**基準**: OWASP Session Management Cheat Sheet

#### 詳細要件

- エントロピー: 最低128ビット
- 生成方法: CSPRNG (Cryptographically Secure Pseudo-Random Number Generator)
- 形式: UUIDv4または128ビット以上のランダムな英数字列
- 予測不可能性: トークンから次のトークンを予測できない

**受入基準**:
- Given: ユーザーがログインする時
- When: セッショントークンが生成される
- Then: トークンは128ビット以上のエントロピーを持ち、予測不可能である

---

### NFR-003: ログイン処理のパフォーマンス (Performance)

**記述**: システムは、ログイン処理を1秒以内（95パーセンタイル）に完了する必要がある。

**カテゴリ**: パフォーマンス
**優先度**: Must have
**測定方法**: 負荷テスト

#### 詳細要件

- 通常ログイン: 95パーセンタイルで1秒以内
- ソーシャルログイン: 95パーセンタイルで2秒以内（外部API依存のため）
- 同時接続数: 1000ユーザー/秒をサポート

**受入基準**:
- Given: 1000ユーザーが同時にログインする負荷テストを実施する時
- When: ログイン処理を実行する
- Then: 95%以上のリクエストが1秒以内に完了する

---

### NFR-004: システム稼働率 (Availability)

**記述**: 認証システムは、99.9%以上の稼働率を保証する必要がある。

**カテゴリ**: 可用性
**優先度**: Must have
**測定方法**: システムモニタリング

#### 詳細要件

- 稼働率: 99.9%以上（月間ダウンタイム43分以内）
- 復旧時間目標 (RTO): 15分以内
- 復旧ポイント目標 (RPO): 5分以内

**受入基準**:
- Given: 本番環境で1ヶ月間運用する時
- When: 稼働率を測定する
- Then: 99.9%以上の稼働率を達成する

---

### NFR-005: GDPR準拠 (Compliance)

**記述**: 認証システムは、GDPR Article 32（データ保護のセキュリティ）に準拠する必要がある。

**カテゴリ**: コンプライアンス
**優先度**: Must have
**法的要件**: GDPR
**測定方法**: コンプライアンス監査

#### 詳細要件

- データの暗号化: 転送時（TLS 1.3）、保管時（AES-256）
- アクセス制御: 役割ベースアクセス制御（RBAC）
- ログ記録: すべてのアクセスをログに記録
- ユーザー権利: アクセス権、訂正権、削除権の実装

**受入基準**:
- Given: GDPR準拠チェックリストを使用する時
- When: 認証システムを監査する
- Then: すべてのチェック項目に合格する

---

### NFR-006: OAuth 2.0セキュリティ (Security)

**記述**: OAuth 2.0実装は、PKCE、state検証などのセキュリティベストプラクティスに準拠する必要がある。

**カテゴリ**: セキュリティ
**優先度**: Must have
**基準**: OAuth 2.0 Security Best Current Practice

#### 詳細要件

- PKCE (Proof Key for Code Exchange): すべてのOAuthフローで使用
- state パラメータ: CSRF攻撃対策
- リダイレクトURI: ホワイトリスト検証
- スコープの最小化: 必要最小限の権限のみ要求

**受入基準**:
- Given: Googleログインフローを実行する時
- When: OAuth 2.0セキュリティチェックツールで検証する
- Then: すべてのセキュリティベストプラクティスに準拠している

---

## 制約

### CON-001: 既存データベースとの互換性

**記述**: 新しい認証システムは、既存のPostgreSQLデータベース（会員テーブル）と互換性を保つ必要がある。

**影響**: 設計、実装
**回避策**: データマイグレーション計画の策定

---

### CON-002: 予算制約

**記述**: 開発予算は500万円以内に収める必要がある。

**影響**: 技術選定、実装範囲
**対策**: OSSライブラリの活用、クラウドサービスの標準機能利用

---

### CON-003: スケジュール制約

**記述**: 2025年3月31日までにリリースする必要がある。

**影響**: 開発スケジュール、優先順位
**対策**: MVP (Minimum Viable Product) アプローチの採用

---

## トレーサビリティ

| ビジネス要求 | ユーザー要求 | 機能要求 | 非機能要求 |
|-------------|-------------|---------|-----------|
| BR-001 | UR-001 | FR-002, FR-003 | NFR-003 |
| BR-002 | UR-003 | FR-004, FR-005 | - |
| BR-003 | - | FR-006 | NFR-001, NFR-002, NFR-005, NFR-006 |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 承認者 |
|-----------|------|---------|--------|
| 1.0 | 2025-01-22 | 初版作成 | 田中 太郎, 佐藤 花子 |

---

**次のステップ**: 設計レビュー（1/30予定）
